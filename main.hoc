load_file("nrngui.hoc")
cvode_active(1)
cvode.atol(0.00001)
cvode.condition_order(2)
wopen("data/Dbl_Taper_20uDF.txt") //output 26,36,44

xopen("1_params.hoc")
xopen("2_geometry.hoc")
xopen("3_conductances.hoc")
xopen("4_stim.hoc")
xopen("5_record.hoc")
xo=20.00
xf=20.00
dx=.25
xmax=(xf-xo)/dx
secondorder=2

proc run_act(){
    initialize()
    stimul()
    run()
}


/* Uses a constant 1mm node-node separation distance that has a constant Fiber/Axon Diameter.
For each run, the nodal diameter is increased from .1Âµm to the diameter of the axon (save myelin).
For each iteration, the conduction velocity is calculated for a given nodal diameter. */
proc run_loop(){
    fprint("%s %s %s %s %s\n","Dn","Dax","ave_velocity","nag","kg")
    for xind=0,xmax{ // Fiber loop
        Df=xo+xind*dx   // Diameter fiber
        Dax=0.66604*Df-0.42879
        nl=(Df-Dax)/(2*tml)
        passiveg=g_nl/(2*nl)
        cm_my=2*eo*er/( Df*log(Df/Dax))
        passivecm=cm_my/(1+cm_my*Df/(cm_n*Dax))
        c_nl=passivecm*(nl)
        kg=kg_per_ch*Pot/(PI*Lflut*Dax*10^-8)

        yo=.2
        dy=.1
        yf=Dax+dy*2
        ymax=(yf-yo)/dy

        for yind=0,ymax { // Node loop

            Dn=yo+yind*dy   // Nodal diameter

            bh=Dn*.32406*exp(-0.39509*Dn)*0.0
            ratio=Dn/Dax
            nag=nag_per_ch*Sod/(PI*Lnode*Dn*10^-8)

            // run simulation
            initialize()
            stimul()
            run()

            // record ap timing at node[i] in apt[i]
            time10=apt[9].x(0)
            time20=apt[19].x(0)

            // record avg velocity between node 9 and 19
            ave_velocity = -1
            if(time20 > time10){
                ave_velocity= (19-9)*Lsection/((time20-time10)*1000)
            }
            if(ave_velocity>-1){
                //fprint("%f %f %f %f %f %f %f %f %f %f\n",Dn,Dax,nl*(2*tml),Df,Lsection,9*Lsection,time20-time10,Avg1,nag,kg)
                //printf("%f %f %f %f %f %f %f %f %f %f\n",Dn,Dax,nl*(2*tml),Df,Lsection,9*Lsection,time20-time10,Avg1,nag,kg)
                fprint("%f %f %f %f %f\n",Dn,Dax,ave_velocity,nag,kg) // (Plotting columns 1 & 3 of the output will provide a conduction-velocity vs Nodal-Diameter curve as seen in our paper)
                printf("%f %f %f %f %f\n",Dn,Dax,ave_velocity,nag,kg)
            }
        }
    }
}


//xopen ("act.ses")
//run_act()
run_loop()